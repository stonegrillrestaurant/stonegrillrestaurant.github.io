<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stone Grill -- Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts & Icons (lightweight + Bootstrap) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/assets/img/favicon-32x32.png" />

  <style>
    body { background:#fff; }
    .brand { font-weight:700; letter-spacing:.5px; }
    .cart-item-row { border-bottom:1px dashed #eee; padding:.75rem 0; }
    .money { font-variant-numeric: tabular-nums; }
    .menu-card img { object-fit:cover; height:160px; width:100%; border-top-left-radius:.5rem; border-top-right-radius:.5rem; }
    .menu-card .price { font-weight:600; }
    .sticky-summary { position:sticky; top:1rem; }
    .gcash-qr { max-width:220px; border-radius:.5rem; border:1px solid #eee; }
    .small-muted { font-size:.9rem; color:#6c757d; }
  </style>
</head>
<body>
  <!-- Topbar -->
  <nav class="navbar navbar-expand-lg bg-light border-bottom">
    <div class="container">
      <a class="navbar-brand brand" href="/"><i class="bi bi-fire"></i> Stone Grill</a>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="/#menu"><i class="bi bi-card-list me-1"></i> Menu</a>
        <a class="btn btn-primary btn-sm" href="https://m.me/stonecitygrill" target="_blank"><i class="bi bi-messenger me-1"></i> Messenger</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="row g-4">

      <!-- LEFT: Simple menu (sample items; replace with your real items/images) -->
      <section class="col-lg-7">
        <h3 class="mb-3">Pick your dishes</h3>

        <div class="row row-cols-1 row-cols-sm-2 g-3">
          <!-- Item -->
          <div class="col">
            <div class="card menu-card h-100 shadow-sm">
              <img src="/assets/img/menu/IMG_0191.png" alt="Set C">
              <div class="card-body">
                <h5 class="card-title">Set C</h5>
                <p class="card-text small">Chicken, Chopsuey, Pancit, Calamares, Crispy Pata, Sisig, 2 Platter Rice, Drinks</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="price money">₱1,980</span>
                  <button class="btn btn-sm btn-outline-primary" onclick="addToCart('Set C', 1980)">Add</button>
                </div>
              </div>
            </div>
          </div>
          <!-- Item -->
          <div class="col">
            <div class="card menu-card h-100 shadow-sm">
              <img src="/assets/img/menu/tuscan-grilled.jpg" alt="Grilled Fish">
              <div class="card-body">
                <h5 class="card-title">Grilled Fish</h5>
                <p class="card-text small">Fresh, tender, grilled over hot stone.</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="price money">₱310</span>
                  <button class="btn btn-sm btn-outline-primary" onclick="addToCart('Grilled Fish', 310)">Add</button>
                </div>
              </div>
            </div>
          </div>
          <!-- Item -->
          <div class="col">
            <div class="card menu-card h-100 shadow-sm">
              <img src="/assets/img/menu/cake.jpg" alt="Calamari">
              <div class="card-body">
                <h5 class="card-title">Calamari</h5>
                <p class="card-text small">Crunchy, golden, zesty dip.</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="price money">₱300</span>
                  <button class="btn btn-sm btn-outline-primary" onclick="addToCart('Calamari', 300)">Add</button>
                </div>
              </div>
            </div>
          </div>
          <!-- Item -->
          <div class="col">
            <div class="card menu-card h-100 shadow-sm">
              <img src="/assets/img/menu/greek-salad.jpg" alt="Scallops">
              <div class="card-body">
                <h5 class="card-title">Scallops</h5>
                <p class="card-text small">Juicy, garlic-butter finish.</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="price money">₱280</span>
                  <button class="btn btn-sm btn-outline-primary" onclick="addToCart('Scallops', 280)">Add</button>
                </div>
              </div>
            </div>
          </div>
          <!-- You can continue adding items the same way -->
        </div>
      </section>

      <!-- RIGHT: Cart + customer details + payment + submit -->
      <aside class="col-lg-5">
        <div class="sticky-summary">
          <div class="card shadow-sm">
            <div class="card-body">
              <h4 class="mb-3">Your Cart</h4>
              <div id="cartList"></div>
              <div class="d-flex justify-content-between mt-2">
                <strong>Subtotal</strong>
                <strong class="money" id="subtotal">₱0.00</strong>
              </div>
              <div class="small text-muted mt-1">Order ID is generated automatically for safety in multi-user mode.</div>

              <hr>

              <!-- Customer details -->
              <h5 class="mt-2">Details</h5>
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label small">Order Type</label>
                  <select class="form-select" id="orderType">
                    <option value="Dine-in">Dine-in</option>
                    <option value="Take-out">Take-out</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label small">Persons</label>
                  <input type="number" class="form-control" id="persons" min="1" value="1">
                </div>
                <div class="col-12">
                  <label class="form-label small">Customer Name</label>
                  <input type="text" class="form-control" id="customerName" placeholder="Your name">
                </div>
                <div class="col-12">
                  <label class="form-label small">Mobile</label>
                  <input type="tel" class="form-control" id="mobile" placeholder="09XXXXXXXXX">
                </div>
                <div class="col-6">
                  <label class="form-label small">Date</label>
                  <input type="date" class="form-control" id="date">
                </div>
                <div class="col-6">
                  <label class="form-label small">Time</label>
                  <input type="time" class="form-control" id="time">
                </div>
                <div class="col-12">
                  <label class="form-label small">Special Requests</label>
                  <textarea class="form-control" id="notes" rows="2" placeholder="No chili, extra rice, etc."></textarea>
                </div>
              </div>

              <hr>

              <!-- Payment -->
              <h5 class="mt-2">Payment</h5>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pay" id="payCash" value="Cash" checked>
                <label class="form-check-label" for="payCash">Cash</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="pay" id="payGCash" value="GCash">
                <label class="form-check-label" for="payGCash">GCash</label>
              </div>

              <div id="gcashBox" class="border rounded p-2 d-none">
                <div class="d-flex align-items-center gap-3">
                  <img class="gcash-qr" src="/assets/img/gcash-qr.png" alt="GCash QR">
                  <div>
                    <div class="fw-semibold">GCash: 09XX XXX XXXX</div>
                    <div class="small-muted">After payment, include reference number in Special Requests.</div>
                  </div>
                </div>
              </div>

              <div class="d-grid mt-3">
                <button class="btn btn-danger btn-lg" id="btnSubmit" onclick="submitOrder()">
                  <i class="bi bi-bag-check me-1"></i> Place Order
                </button>
              </div>
              <div class="small-muted mt-2" id="statusMsg"></div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="border-top py-4">
    <div class="container small text-center text-muted">
      © 2025 Stone Grill Restaurant • <a href="https://m.me/stonecitygrill" target="_blank">Message us on Facebook</a>
    </div>
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ====== CONFIG ======
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzwQesykbPaic1wpEGyYxWH9UWSekbKz9uAdwJXqoLC31a5VixRNSFj46VaDZ1jx_EymQ/exec";

    // ====== CART STATE ======
    const CART_KEY = 'sgr_cart_v1';
    let cart = loadCart();

    function loadCart() {
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; }
    }
    function saveCart() { localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
    function money(n){ return '₱' + Number(n||0).toFixed(2); }

    function addToCart(name, price) {
      const found = cart.find(i => i.name===name && Number(i.price)===Number(price));
      if (found) found.qty += 1;
      else cart.push({ name, price: Number(price), qty: 1 });
      saveCart(); renderCart();
    }

    function changeQty(idx, delta) {
      cart[idx].qty = Math.max(0, cart[idx].qty + delta);
      if (cart[idx].qty === 0) cart.splice(idx,1);
      saveCart(); renderCart();
    }

    function removeItem(idx){
      cart.splice(idx,1);
      saveCart(); renderCart();
    }

    function cartSubtotal(){
      return cart.reduce((s,i)=> s + (Number(i.price)*Number(i.qty||0)), 0);
    }

    function renderCart() {
      const box = document.getElementById('cartList');
      box.innerHTML = '';
      if (cart.length===0) {
        box.innerHTML = '<div class="text-muted small">Your cart is empty.</div>';
      } else {
        cart.forEach((i,idx)=>{
          const row = document.createElement('div');
          row.className = 'cart-item-row d-flex align-items-center justify-content-between';
          row.innerHTML = `
            <div class="me-2">
              <div class="fw-semibold">${i.name}</div>
              <div class="text-muted small">x${i.qty} • <span class="money">${money(i.price)}</span></div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-sm btn-outline-secondary" onclick="changeQty(${idx},-1)">−</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="changeQty(${idx},+1)">+</button>
              <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${idx})"><i class="bi bi-x"></i></button>
            </div>
          `;
          box.appendChild(row);
        });
      }
      document.getElementById('subtotal').textContent = money(cartSubtotal());
    }

    // Payment toggle
    document.addEventListener('change', (e)=>{
      if (e.target && e.target.name === 'pay') {
        document.getElementById('gcashBox').classList.toggle('d-none', e.target.value !== 'GCash');
      }
    });

    // ====== SUBMIT ORDER ======
    async function submitOrder() {
      const status = document.getElementById('statusMsg');
      status.textContent = '';

      if (cart.length===0) { alert('Please add at least one item.'); return; }

      const orderId = 'SGR-' + Date.now();  // multi-user safe unique ID

      // Collect form fields
      const payload = {
        orderId,
        orderType: document.getElementById('orderType').value,
        persons: Number(document.getElementById('persons').value || 1),
        customerName: document.getElementById('customerName').value.trim(),
        mobile: document.getElementById('mobile').value.trim(),
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        items: cart.map(i=>({ name:i.name, price:Number(i.price), qty:Number(i.qty) })),
        subtotal: cartSubtotal(),
        specialRequests: document.getElementById('notes').value.trim()
      };

      // Minimal field validations
      if (!payload.customerName || !payload.mobile || !payload.date || !payload.time) {
        alert('Please complete Customer Name, Mobile, Date and Time.'); return;
      }

      const btn = document.getElementById('btnSubmit');
      btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';

      try {
        const res = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data.ok) {
          status.textContent = '✅ Order placed! Sent to kitchen & saved to sheet.';
          // reset
          cart = []; saveCart(); renderCart();
          // Optional: clear fields
          // document.getElementById('customerName').value='';
          // document.getElementById('mobile').value='';
          // document.getElementById('notes').value='';
          alert('Order submitted!\nOrder ID: ' + orderId);
        } else {
          console.error('Server error:', data);
          status.textContent = '⚠️ Could not submit order. Please try again.';
          alert('Could not submit order. Please try again.');
        }
      } catch (err) {
        console.error(err);
        status.textContent = '🚫 Network error. Please check your internet and try again.';
        alert('Network error. Please try again.');
      } finally {
        btn.disabled = false; btn.innerHTML = '<i class="bi bi-bag-check me-1"></i> Place Order';
      }
    }

    // Init
    renderCart();
  </script>
</body>
</html>